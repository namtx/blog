<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Locking in AR | namtx.dev </title> <meta name="description" content=" Ruby on Rails, Devops and more "> <meta name="keywords" content="blog, web, devops, ruby on rails"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Tran Xuan Nam"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2017-07-10 00:00:00 +0000"> <meta property="og:url" content="https://namtx.github.io/2017/Locking+in+AR/"> <meta property="og:title" content=" Locking in AR | namtx.dev "> <meta property="og:image" content="https://namtx.github.io"> <meta property="og:description" content=" Ruby on Rails, Devops and more "> <meta property="og:site_name" content="Tran Xuan Nam"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" Locking in AR | namtx.dev "> <meta name="twitter:description" content=" Ruby on Rails, Devops and more "> <meta name="twitter:image:src" content="https://namtx.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" Locking in AR | namtx.dev "> <meta itemprop="description" content=" Ruby on Rails, Devops and more "> <meta itemprop="image" content="https://namtx.github.io"> <!-- Canonical link tag --> <link rel="canonical" href="https://namtx.github.io/2017/Locking+in+AR/"> <link rel="alternate" type="application/rss+xml" title="namtx.dev" href="https://namtx.github.io/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="https://namtx.github.io/assets/css/main.css"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="https://namtx.github.io/">namtx<span>.dev</span></a></h1> <ul class="navbar"> <li><a href="https://namtx.github.io/about">About me</a></li> <li><a href="https://bookmarks.namtx.now.sh/" target="_blank">Bookmarks</a></li> <li><a href="https://namtx.github.io/til">TIL</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2017-07-10T00:00:00+00:00" itemprop="datePublished">Jul 10, 2017</time></p> <h1 class="post-title" itemprop="name headline">Locking in AR</h1> </header> <div class="post-content" itemprop="articleBody"> <p> </p> <h2 id="optimistic-locking">Optimistic Locking</h2> <p>Trong loại này, nhiều người dùng có thể truy cập cùng một đối tượng để đọc giá trị của nó, nhưng nếu hai người dùng thực hiện cập nhật thì sẽ phát sinh mâu thuẫn, chỉ có một người sử dụng sẽ thành công và một trong những người khác sẽ không được thực hiện.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p1</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p1</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>
<span class="n">p1</span><span class="p">.</span><span class="nf">save</span>

<span class="n">p2</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s2">"should fail"</span>
<span class="n">p2</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># Raises a ActiveRecord::StaleObjectError </span>
</code></pre></div></div> <p>Để tạo Optimistic locking, bạn có thể tạo ra một field lock_version mà bạn muốn đặt khóa và Rails sẽ tự động kiểm tra trước khi cập nhật các đối tượng. Cơ chế của nó là khá đơn giản. Mỗi lần các đối tượng được cập nhật, giá trị lock_version sẽ được tăng lên. Do đó, nếu hai yêu cầu muốn thực hiện cùng một đối tượng, yêu cầu đầu tiên sẽ thành công vì lock_version của nó cũng giống như khi nó được đọc. Nhưng yêu cầu thứ hai sẽ thất bại vì lock_version đã được tăng lên trong cơ sở dữ liệu của các yêu cầu đầu tiên.</p> <h2 id="pessimistic-locking">Pessimistic Locking</h2> <p>Với loại locking này, chỉ có người dùng đầu tiên truy cập đến các đối tượng sẽ có thể cập nhật nó. Tất cả những người dùng khác sẽ bị loại khỏi thậm chí đọc các đối tượng (hãy nhớ rằng trong Optimistic locking, chúng tôi chỉ khóa nó khi cập nhật dữ liệu và người dùng vẫn có thể đọc nó).</p> <p>Rails sẽ thực hiện Pessimistic Locking bằng cách phát hành truy vấn đặc biệt trong cơ sở dữ liệu. Ví dụ, giả sử bạn muốn lấy đối tượng tài khoản và khóa nó cho đến khi bạn hoàn thành việc cập nhật:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">find_by_user_id</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">account</span><span class="p">.</span><span class="nf">lock!</span>
<span class="c1">#no other users can read this account, they have to wait until the lock is released</span>
<span class="n">account</span><span class="p">.</span><span class="nf">save!</span> 
<span class="c1">#lock is released, other users can read this account</span>
</code></pre></div></div> </div> </article> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2021 Tran Xuan Nam &middot; &lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/thinkspace">Thinkspace theme</a></small> </div> </footer> </main> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-XXXXX-XX']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
