<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> [Ruby] freeze object | namtx.dev </title> <meta name="description" content=" Ruby on Rails, Devops and more "> <meta name="keywords" content="blog, web, devops, ruby on rails"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Tran Xuan Nam"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2017-05-09 00:00:00 +0000"> <meta property="og:url" content="https://namtx.github.io/2017/_ruby-_freeze_object/"> <meta property="og:title" content=" [Ruby] freeze object | namtx.dev "> <meta property="og:image" content="https://namtx.github.io"> <meta property="og:description" content=" Ruby on Rails, Devops and more "> <meta property="og:site_name" content="Tran Xuan Nam"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" [Ruby] freeze object | namtx.dev "> <meta name="twitter:description" content=" Ruby on Rails, Devops and more "> <meta name="twitter:image:src" content="https://namtx.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" [Ruby] freeze object | namtx.dev "> <meta itemprop="description" content=" Ruby on Rails, Devops and more "> <meta itemprop="image" content="https://namtx.github.io"> <!-- Canonical link tag --> <link rel="canonical" href="https://namtx.github.io/2017/_ruby-_freeze_object/"> <link rel="alternate" type="application/rss+xml" title="namtx.dev" href="https://namtx.github.io/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="https://namtx.github.io/assets/css/main.css"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="https://namtx.github.io/">namtx<span>.dev</span></a></h1> <ul class="navbar"> <li><a href="https://namtx.github.io/about">About me</a></li> <li><a href="https://bookmarks.namtx.now.sh/" target="_blank">Bookmarks</a></li> <li><a href="https://namtx.github.io/til">TIL</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2017-05-09T00:00:00+00:00" itemprop="datePublished">May 9, 2017</time></p> <h1 class="post-title" itemprop="name headline">[Ruby] freeze object</h1> </header> <div class="post-content" itemprop="articleBody"> <p> </p> <h2 id="creating-immutable-objects">Creating immutable objects</h2> <blockquote> <p>In Ruby constant is mutable</p> </blockquote> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">MY_CONSTANT</span> <span class="o">=</span> <span class="s2">"foo"</span>
<span class="no">MY_CONSTANT</span> <span class="o">&lt;&lt;</span> <span class="s2">"bar"</span>
<span class="nb">p</span> <span class="no">MY_CONSTANT</span>
<span class="c1">#=&gt; "foo bar"</span>
</code></pre></div></div> <p>But with freeze, when you attempt to change the frozen object -&gt; Runtime Error</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">MY_CONSTANT</span> <span class="o">=</span> <span class="s2">"foo"</span><span class="p">.</span><span class="nf">freeze</span>
<span class="no">MY_CONSTANT</span> <span class="o">&lt;&lt;</span> <span class="s2">" bar"</span>
<span class="c1">#=&gt; `&lt;main&gt;': can't modify frozen String (RuntimeError)</span>
</code></pre></div></div> <p>Real-world example ActionDispatch codebase, Rails hides sensitive data by logging ‘[FILTERED]’ literal string, this text is stored in constant frozen.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ActionDispatch</span>
  <span class="k">module</span> <span class="nn">Http</span>
    <span class="k">class</span> <span class="nc">ParametersFilter</span>
      <span class="no">FILTER</span> <span class="o">=</span> <span class="s1">'[FILTERED]'</span><span class="p">.</span><span class="nf">freeze</span>
<span class="o">...</span>
</code></pre></div></div> <h2 id="reducing-object-allocation">Reducing object allocation</h2> <p>One of best things to speed up Ruby on decrease number of objects are created. In your app, a method call <code class="highlighter-rouge">log("foobar")</code>, it is creating a String object. With freeze, Ruby interpreter will create only one String literal and caches it for feature use.</p> <blockquote> <p>50% performance increase ```ruby require “benchmark/ips”</p> </blockquote> <p>def noop arg end</p> <p>Benchmark.ips do |x| x.report(“normal”){noop “foo”} x.report(“frozen”){noop “foo”.free} end</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
&gt; Warming up --------------------------------------
              normal   328.890k i/100ms
              frozen   357.420k i/100ms
Calculating -------------------------------------
              normal      8.535M (± 2.4%) i/s -     42.756M in   5.012534s
              frozen     10.428M (± 4.4%) i/s -     52.183M in   5.014607s

Real-world example, in Rails routes, the router is used for every request =&gt; freeze String literal.
```ruby
# excerpted from https://github.com/rails/rails/blob/f91439d848b305a9d8f83c10905e5012180ffa28/actionpack/lib/action_dispatch/journey/router/utils.rb#L15
def self.normalize_path(path)
  path = "/#{path}"
  path.squeeze!('/'.freeze)
  path.sub!(%r{/+\Z}, ''.freeze)
  path.gsub!(/(%[a-f0-9]{2})/) { $1.upcase }
  path = '/' if path == ''.freeze
  path
end
</code></pre></div></div> <h2 id="ruby--22">Ruby &gt;= 2.2</h2> <p>Optimization is included in <code class="highlighter-rouge">Ruby 2.2</code> and later. frozen string literal is used for hash key</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="c1">#Ruby 2.2</span>
<span class="n">user</span><span class="p">[</span><span class="s2">"name"</span><span class="p">.</span><span class="nf">freeze</span><span class="p">]</span> <span class="c1">#Ruby 2.1</span>
</code></pre></div></div> <h2 id="freeze-object-in-initialize-methods">Freeze object in <code class="highlighter-rouge">initialize</code> methods</h2> </div> </article> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2021 Tran Xuan Nam &middot; &lt;/&gt; Powered by <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://github.com/heiswayi/thinkspace">Thinkspace theme</a></small> </div> </footer> </main> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-XXXXX-XX']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
